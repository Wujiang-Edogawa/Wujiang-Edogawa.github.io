<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åƒç¦§æ—¶å…‰ | æ¢¦æ ¸ç›¸å†Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8A2BE2;
            --secondary: #FF69B4;
            --bg: #0A0A1A;
            --text: #F0F0FF;
            --accent: #00FFFF;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        h1, h2, h3 {
            color: var(--accent);
            text-shadow: 0 0 8px var(--accent);
            margin-bottom: 20px;
            text-align: center;
        }

        .login-box, .upload-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--accent);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid var(--accent);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            font-size: 16px;
        }

        button {
            background: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover {
            background: var(--secondary);
            box-shadow: 0 0 15px var(--accent);
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .photo-info {
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            font-size: 14px;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.7);
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }

        .audio-player {
            margin: 20px 0;
            text-align: center;
        }

        .hidden {
            display: none;
        }

        .year-group {
            margin: 30px 0;
        }

        .year-title {
            color: var(--secondary);
            font-size: 24px;
            margin: 20px 0 10px;
            text-align: left;
        }

        #bgm-audio {
            width: 100%;
            margin: 10px 0;
        }

        .book-wrapper {
            position: relative;
            width: 100%;
            max-width: 720px;
            margin: 0 auto 2rem;
            perspective: 1500px;
        }

        .book-page {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            transform-style: preserve-3d;
            transform-origin: left center;
            transition: transform 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .book-page.turn {
            transform: rotateY(-180deg);
        }

        .book-page img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        }

        .book-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .book-nav button {
            width: auto;
            padding: 6px 18px;
        }

        .book-nav button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="login-section" class="login-box">
            <h1>åƒç¦§æ—¶å…‰</h1>
            <p style="text-align: center; margin-bottom: 20px;">è¯·è¾“å…¥ä½ çš„ã€Œæ—¶å…‰å¯†é’¥ã€ä»¥å¼€å¯å›å¿†</p>
            <input type="text" id="key-input" placeholder="ä»»æ„å­—ç¬¦å³å¯ï¼Œå¦‚ï¼šmoon2025" maxlength="50">
            <button onclick="login()">è¿›å…¥ç›¸å†Œ</button>
        </div>

        <!-- ä¸»ç•Œé¢ -->
        <div id="main-section" class="hidden">
            <h1>åƒç¦§æ—¶å…‰ Â· æ¢¦æ ¸ç›¸å†Œ</h1>
            <p style="text-align: center; margin-bottom: 20px;">å¯†é’¥ï¼š<span id="user-key"></span></p>
            
            <div class="audio-player">
                <h3>ğŸµ æ¢¦æ ¸ BGM Â· åƒç¦§æ—¶å…‰</h3>
                <audio id="bgm-audio" controls loop>
                    <source src="https://res.cloudinary.com/dv1ghhue3/video/upload/v1762852048/nop_tnar44.mp3" type="audio/mpeg">
                </audio>
            </div>

            <div class="upload-section">
                <h3>ğŸ“¤ ä¸Šä¼ æ–°ç…§ç‰‡</h3>
                <input type="file" id="file-input" accept="image/*">
                <select id="year-select">
                    <!-- å¹´ä»½é€‰é¡¹å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                </select>
                <button onclick="uploadPhoto()">ä¸Šä¼ </button>
            </div>

            <div id="gallery" class="gallery"></div>
            
            <div class="book-wrapper hidden" id="book-wrapper">
                <div id="book-page" class="book-page"></div>
                <div class="book-nav">
                    <button id="prev-btn" onclick="navigatePage(-1)">â—€ ä¸Šä¸€é¡µ</button>
                    <span id="page-info">1 / 1</span>
                    <button id="next-btn" onclick="navigatePage(1)">ä¸‹ä¸€é¡µ â–¶</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentKey = '';
        let photos = [];
        let currentPage = 0;
        const photosPerPage = 4;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            generateYearOptions();
            loadFromLocalStorage();
        });

        // ç”Ÿæˆå¹´ä»½é€‰é¡¹
        function generateYearOptions() {
            const yearSelect = document.getElementById('year-select');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= 1950; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                yearSelect.appendChild(option);
            }
        }

        // ç™»å½•
        function login() {
            const key = document.getElementById('key-input').value.trim();
            if (!key) {
                alert('å¯†é’¥ä¸èƒ½ä¸ºç©º');
                return;
            }
            currentKey = key;
            document.getElementById('user-key').textContent = key;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            loadPhotos();
        }

        // æ–° uploadPhotoï¼šå…ˆæ‹¿ç­¾å â†’ å†ç›´ä¼  Cloudinary
        async function uploadPhoto() {
        const fileInput = document.getElementById('file-input');
        const yearSelect = document.getElementById('year-select');
        const file = fileInput.files[0];
        if (!file) { alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡'); return; }

        const folder = `time-keys/${currentKey}`;          // ä¸åŸ Python ä¿æŒä¸€è‡´
        const signResp = await fetch('/api/sign', {        // â‘  å–ç­¾å
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder })
        });
        const { timestamp, signature } = await signResp.json();

        const fd = new FormData();
        fd.append('file', file);
        fd.append('api_key', '852246619638176');
        fd.append('timestamp', timestamp);
        fd.append('signature', signature);
        fd.append('folder', folder);
        fd.append('context', `taken_year=${yearSelect.value}|original_name=${file.name}|upload_time=${new Date().toLocaleString()}`);

        const upResp = await fetch(`https://api.cloudinary.com/v1_1/dv1ghhue3/image/upload`, {
                method: 'POST', body: fd
        });
        const data = await upResp.json();

        // æŠŠ Cloudinary è¿”å›çš„ URL å­˜è¿›æœ¬åœ°æ•°ç»„
        photos.push({
                id: data.public_id,
                url: data.secure_url,
                name: file.name,
                year: yearSelect.value,
                uploadTime: new Date().toLocaleString()
        });
        saveToLocalStorage();
        loadPhotos();
        fileInput.value = '';
        alert('ä¸Šä¼ æˆåŠŸï¼');
        }

        // åŠ è½½ç…§ç‰‡
        function loadPhotos() {
            const gallery = document.getElementById('gallery');
            const bookWrapper = document.getElementById('book-wrapper');
            
            if (photos.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; opacity: 0.6;">è¿˜æ²¡æœ‰ç…§ç‰‡ï¼Œå…ˆä¸Šä¼ ä¸€å¼ å§~</p>';
                bookWrapper.classList.add('hidden');
                return;
            }

            // æŒ‰å¹´ä»½åˆ†ç»„
            const groupedPhotos = {};
            photos.forEach(photo => {
                if (!groupedPhotos[photo.year]) {
                    groupedPhotos[photo.year] = [];
                }
                groupedPhotos[photo.year].push(photo);
            });

            // æ˜¾ç¤ºç”»å»Š
            gallery.innerHTML = '';
            Object.keys(groupedPhotos).sort((a, b) => b - a).forEach(year => {
                const yearGroup = document.createElement('div');
                yearGroup.className = 'year-group';
                
                const yearTitle = document.createElement('h2');
                yearTitle.className = 'year-title';
                yearTitle.textContent = year + 'å¹´';
                yearGroup.appendChild(yearTitle);

                const yearPhotos = document.createElement('div');
                yearPhotos.className = 'gallery';
                
                groupedPhotos[year].forEach(photo => {
                    const photoItem = createPhotoElement(photo);
                    yearPhotos.appendChild(photoItem);
                });
                
                yearGroup.appendChild(yearPhotos);
                gallery.appendChild(yearGroup);
            });

            // æ˜¾ç¤ºä¹¦é¡µæ¨¡å¼
            displayBookMode();
        }

        // åˆ›å»ºç…§ç‰‡å…ƒç´ 
        function createPhotoElement(photo) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            
            const img = document.createElement('img');
            img.src = photo.url;
            img.alt = photo.name;
            
            const photoInfo = document.createElement('div');
            photoInfo.className = 'photo-info';
            photoInfo.innerHTML = `
                <div>${photo.name}</div>
                <div style="font-size: 12px; opacity: 0.7;">${photo.uploadTime}</div>
            `;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'ğŸ—‘ï¸';
            deleteBtn.onclick = function() {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ')) {
                    deletePhoto(photo.id);
                }
            };
            
            photoItem.appendChild(img);
            photoItem.appendChild(photoInfo);
            photoItem.appendChild(deleteBtn);
            
            return photoItem;
        }

        // åˆ é™¤ç…§ç‰‡
        async function deletePhoto(publicId) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            await fetch('/api/sign', {          // å¤ç”¨åŒä¸€ä¸ªäº‘å‡½æ•°æ‹¿ç­¾å
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ public_id: publicId })
            });
            photos = photos.filter(p => p.id !== publicId);
            saveToLocalStorage();
            loadPhotos();
        }

        // ä¹¦é¡µæ¨¡å¼æ˜¾ç¤º
        function displayBookMode() {
            const bookWrapper = document.getElementById('book-wrapper');
            const bookPage = document.getElementById('book-page');
            
            if (photos.length === 0) {
                bookWrapper.classList.add('hidden');
                return;
            }
            
            bookWrapper.classList.remove('hidden');
            updateBookPage();
        }

        // æ›´æ–°ä¹¦é¡µå†…å®¹
        function updateBookPage() {
            const bookPage = document.getElementById('book-page');
            const start = currentPage * photosPerPage;
            const pagePhotos = photos.slice(start, start + photosPerPage);
            
            bookPage.innerHTML = pagePhotos.map(photo => 
                `<div><img src="${photo.url}" title="${photo.name}" /></div>`
            ).join('');
            
            // æ›´æ–°é¡µç ä¿¡æ¯
            const totalPages = Math.ceil(photos.length / photosPerPage);
            document.getElementById('page-info').textContent = `${currentPage + 1} / ${totalPages}`;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('prev-btn').disabled = currentPage === 0;
            document.getElementById('next-btn').disabled = currentPage >= totalPages - 1;
        }

        // ç¿»é¡µ
        function navigatePage(delta) {
            const totalPages = Math.ceil(photos.length / photosPerPage);
            const newPage = currentPage + delta;
            
            if (newPage >= 0 && newPage < totalPages) {
                // æ·»åŠ ç¿»é¡µåŠ¨ç”»
                const bookPage = document.getElementById('book-page');
                bookPage.classList.add('turn');
                
                setTimeout(() => {
                    currentPage = newPage;
                    updateBookPage();
                    bookPage.classList.remove('turn');
                }, 300);
            }
        }

        // æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            localStorage.setItem(`photos_${currentKey}`, JSON.stringify(photos));
        }

        function loadFromLocalStorage() {
            if (currentKey) {
                const stored = localStorage.getItem(`photos_${currentKey}`);
                if (stored) {
                    photos = JSON.parse(stored);
                    loadPhotos();
                }
            }
        }

        // è·å–EXIFä¿¡æ¯
        function getExifYear(file) {
            // è¿™é‡Œéœ€è¦å®ç°EXIFè¯»å–åŠŸèƒ½
            // ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
            return '';
        }
    </script>
</body>
</html>